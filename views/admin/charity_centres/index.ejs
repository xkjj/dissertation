<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Charity Centres</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
</head>

<body>

<div class="container mt-2 py-4 mb-4 bg-dark rounded-3 text-white">
    <div class="p-4">
        <h2 class="fw-bolder display-5">Charity Centres</h2>
        <p class="lead">Manage registered charity centres</p>
    </div>
</div>

<div class="container">

    <a href="/admin/charity-centres/new" class="btn btn-dark mb-3">
        + Add Charity Centre
    </a>

    <% if (charities.length === 0) { %>
        <div class="alert alert-info">
            No charity centres have been created yet.
        </div>
    <% } else { %>

        <table class="table table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Postcode</th>
                    <th>Charity Status</th>
                    <th>Current Admin</th>
                    <th>Assign Charity Admin</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% charities.forEach(c => { %>
                    <tr>
                        <td><%= c.charity_name %></td>
                        <td><%= c.charity_email %></td>
                        <td><%= c.charity_postcode %></td>
                        <td>
                            <% if (c.is_active) { %>
                                <span class="badge bg-success">Active</span>
                            <% } else { %>
                                <span class="badge bg-danger">Disabled</span>
                            <% } %>
                        </td>
                        <td>
                            <% if (c.admin_username) { %>

                            <span class="badge bg-success">
                                <%= c.admin_username %>
                            </span>

                            <form action="/admin/charity-centres/remove-admin"
                                method="POST"
                                class="d-inline ms-2">

                                <input type="hidden"
                                    name="charity_id"
                                    value="<%= c.charity_id %>">

                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('Remove this admin from the charity?');">
                                    Remove
                                </button>

                            </form>

                        <% } else { %>

                            <span class="badge bg-secondary">
                                Not Assigned
                            </span>

                        <% } %>

                        </td>
                        <td>
                            <form action="/admin/charity-centres/assign-admin"
                                method="POST"
                                class="d-flex">

                                <input type="hidden"
                                    name="charity_id"
                                    value="<%= c.charity_id %>">
                                <select name="user_id"
                                        class="form-select form-select-sm me-2"
                                        <%= c.is_active === 0 ? 'disabled' : '' %>
                                        required>
                                    <option value="">Select Admin</option>

                                    <% admins.forEach(admin => { %>

                                        <% 
                                            const isAssignedElsewhere =
                                                admin.charity_id &&
                                                admin.charity_id !== c.charity_id;
                                        %>

                                        <% if (!isAssignedElsewhere) { %>
                                            <option value="<%= admin.user_id %>"
                                                <%= c.admin_id === admin.user_id ? 'selected' : '' %>>
                                                <%= admin.username %>
                                            </option>
                                        <% } %>

                                    <% }) %>
                                </select>
                                <button class="btn btn-sm btn-dark"
                                        <%= c.is_active === 0 ? 'disabled' : '' %>>
                                    Assign
                                </button>
                            </form>

                        </td>
                        <td>
                            <a href="/admin/charity-centres/<%= c.charity_id %>/edit"
                               class="btn btn-sm btn-outline-dark">
                                Edit
                            </a>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>

    <% } %>

    <a href="/admin/dashboard" class="btn btn-outline-dark mt-3">
        Back to Dashboard
    </a>

</div>

</body>
</html>
